name: Build iOS & Android Apps

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      app_to_build:
        description: 'Select app to build'
        required: false
        type: choice
        default: 'all'
        options:
          - all
          - hggzk_app
          - hggzkportal_app
          # - rezmate_app
          # - rezmateportal_app
      platform:
        description: 'Platform to build'
        required: false
        type: choice
        default: 'both'
        options:
          - both
          - ios
          - android
      ssh:
        description: 'Enable SSH debug session (tmate). Only works for workflow_dispatch.'
        type: boolean
        required: false
        default: false

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“Œ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…ÙØ¹Ù„Ø© - Ø¹Ø¯Ù‘Ù„ Ù‡Ù†Ø§ ÙÙ‚Ø· Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø¥Ø²Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
env:
  # Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…ÙØ¹Ù„Ø© (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø©ØŒ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª)
  ENABLED_APPS: "hggzk_app,hggzkportal_app"
  # Ù„ØªÙØ¹ÙŠÙ„ ÙƒÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§ØªØŒ Ø§Ø³ØªØ®Ø¯Ù…:
  # ENABLED_APPS: "hggzk_app,hggzkportal_app,rezmate_app,rezmateportal_app"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Setup Build Matrix
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  setup:
    name: Setup Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_apps: ${{ steps.set-matrix.outputs.has_apps }}
    steps:
      - name: Set up build matrix
        id: set-matrix
        run: |
          echo "==========================================="
          echo "ðŸ“‹ Setting up build matrix"
          echo "==========================================="
          
          # Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…ÙØ¹Ù„Ø© Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦ÙŠ
          ENABLED_APPS="${{ env.ENABLED_APPS }}"
          echo "Enabled apps: $ENABLED_APPS"
          
          # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© JSON
          # hggzk_app,hggzkportal_app -> ["hggzk_app","hggzkportal_app"]
          APPS_JSON=$(echo "$ENABLED_APPS" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
          echo "Apps JSON: $APPS_JSON"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯
          SELECTED_APP="${{ github.event.inputs.app_to_build }}"
          echo "Selected app: $SELECTED_APP"
          
          if [ "$SELECTED_APP" == "all" ] || [ -z "$SELECTED_APP" ]; then
            # Ø¨Ù†Ø§Ø¡ ÙƒÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…ÙØ¹Ù„Ø©
            echo "matrix=$APPS_JSON" >> $GITHUB_OUTPUT
            echo "âœ… Will build all enabled apps: $ENABLED_APPS"
          else
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¹Ù„Ø©
            if echo "$ENABLED_APPS" | grep -q "$SELECTED_APP"; then
              echo "matrix=[\"$SELECTED_APP\"]" >> $GITHUB_OUTPUT
              echo "âœ… Will build selected app: $SELECTED_APP"
            else
              echo "âŒ Error: App '$SELECTED_APP' is not in enabled apps list!"
              echo "Enabled apps: $ENABLED_APPS"
              echo "matrix=[]" >> $GITHUB_OUTPUT
              echo "has_apps=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "has_apps=true" >> $GITHUB_OUTPUT
          echo ""
          echo "==========================================="

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Build iOS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-ios:
    name: Build ${{ matrix.app }} for iOS
    needs: setup
    if: |
      needs.setup.outputs.has_apps == 'true' && 
      github.event.inputs.platform != 'android'
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      COCOAPODS_DISABLE_STATS: "true"
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Verify Xcode version
        run: |
          echo "âœ… Selected Xcode version:"
          xcodebuild -version
          echo ""
          echo "Developer Directory:"
          xcode-select -p

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set App Configuration
        id: app-config
        run: |
          echo "==========================================="
          echo "âš™ï¸  Setting configuration for ${{ matrix.app }}"
          echo "==========================================="
          
          case "${{ matrix.app }}" in
            "hggzk_app")
              echo "PROFILE_PATH=cer_ios/Provision_Profile_2.mobileprovision" >> "$GITHUB_ENV"
              echo "BUNDLE_ID=com.hggzk.app" >> "$GITHUB_ENV"
              echo "APP_DISPLAY_NAME=HGGZK" >> "$GITHUB_ENV"
              ;;
            "hggzkportal_app")
              echo "PROFILE_PATH=cer_ios/hggzkportal.mobileprovision" >> "$GITHUB_ENV"
              echo "BUNDLE_ID=com.hggzkportal.app" >> "$GITHUB_ENV"
              echo "APP_DISPLAY_NAME=HGGZK Portal" >> "$GITHUB_ENV"
              ;;
            "rezmate_app")
              echo "PROFILE_PATH=cer_ios/rezmate.mobileprovision" >> "$GITHUB_ENV"
              echo "BUNDLE_ID=com.rezmate.app" >> "$GITHUB_ENV"
              echo "APP_DISPLAY_NAME=Rezmate" >> "$GITHUB_ENV"
              ;;
            "rezmateportal_app")
              echo "PROFILE_PATH=cer_ios/rezmateportal.mobileprovision" >> "$GITHUB_ENV"
              echo "BUNDLE_ID=com.rezmate.portal" >> "$GITHUB_ENV"
              echo "APP_DISPLAY_NAME=Rezmate Portal" >> "$GITHUB_ENV"
              ;;
            *)
              echo "âŒ Unknown app: ${{ matrix.app }}"
              exit 1
              ;;
          esac
          
          echo "âœ… Configuration set successfully"
          echo "==========================================="

      - name: Setup App Store Connect API Key
        env:
          API_KEY_BASE64: ${{ secrets.APPSTORE_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID }}
        run: |
          set -euo pipefail
          echo "--- Setting up App Store Connect API ---"
          
          mkdir -p ~/private_keys
          
          if [ -n "${API_KEY_BASE64:-}" ]; then
            echo "$API_KEY_BASE64" | base64 -d > ~/private_keys/AuthKey_${API_KEY_ID}.p8
            chmod 600 ~/private_keys/AuthKey_${API_KEY_ID}.p8
            echo "âœ… App Store Connect API Key configured"
            echo "Key ID: $API_KEY_ID"
            echo "Issuer ID: $API_ISSUER_ID"
            echo "API_KEY_PATH=$HOME/private_keys/AuthKey_${API_KEY_ID}.p8" >> "$GITHUB_ENV"
          else
            echo "âš ï¸  App Store Connect API Key not provided"
            echo "âš ï¸  Will fallback to manual signing"
            echo "API_KEY_PATH=" >> "$GITHUB_ENV"
          fi

      - name: SSH debug (tmate)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.ssh }}
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

      - name: Flutter version
        run: flutter --version

      - name: Install CocoaPods
        run: |
          if ! command -v pod >/dev/null; then
            sudo gem install cocoapods
          fi
          pod --version

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ matrix.app }}-${{ hashFiles(format('{0}/ios/Podfile', matrix.app), format('{0}/pubspec.lock', matrix.app)) }}
          restore-keys: |
            ${{ runner.os }}-pods-${{ matrix.app }}-

      - name: Flutter clean
        working-directory: ./${{ matrix.app }}
        run: flutter clean

      - name: Flutter pub get
        working-directory: ./${{ matrix.app }}
        run: flutter pub get

      - name: Pod install
        working-directory: ./${{ matrix.app }}
        run: |
          rm -rf ios/Pods ios/Podfile.lock ios/.symlinks
          cd ios
          pod install --repo-update

      - name: Build iOS (PR - no codesign)
        if: ${{ github.event_name == 'pull_request' }}
        working-directory: ./${{ matrix.app }}
        run: flutter build ios --release --no-codesign

      - name: Setup iOS code signing
        if: ${{ github.event_name != 'pull_request' }}
        env:
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail
          
          echo "==========================================="
          echo "ðŸ” Setting up code signing for ${{ matrix.app }}"
          echo "==========================================="
          echo "Bundle ID: $BUNDLE_ID"
          echo "Profile: $PROFILE_PATH"
          echo ""
          
          # ØªÙ†Ø¸ÙŠÙ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
          IOS_P12_PASSWORD_CLEAN="$(printf %s "$IOS_P12_PASSWORD" | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
          KEYCHAIN_PASSWORD_CLEAN="$(printf %s "$KEYCHAIN_PASSWORD" | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Secrets
          if [ -z "${IOS_P12_PASSWORD_CLEAN:-}" ]; then
            echo "âŒ Missing or empty secret: IOS_P12_PASSWORD"
            exit 1
          fi
          if [ -z "${KEYCHAIN_PASSWORD_CLEAN:-}" ]; then
            echo "âŒ Missing or empty secret: IOS_KEYCHAIN_PASSWORD"
            exit 1
          fi
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ø±ÙŠØ¨Ùˆ
          CERT_P12="cer_ios/ios_development.p12"
          PROFILE="$PROFILE_PATH"
          
          if [ ! -f "$CERT_P12" ]; then
            echo "âŒ Missing certificate file: $CERT_P12"
            exit 1
          fi
          if [ ! -f "$PROFILE" ]; then
            echo "âŒ Missing provisioning profile: $PROFILE"
            echo "Available profiles in cer_ios/:"
            ls -la cer_ios/*.mobileprovision 2>/dev/null || echo "No profiles found"
            exit 1
          fi
          
          echo "--- Certificate file info ---"
          ls -lh "$CERT_P12"
          file "$CERT_P12"
          shasum -a 256 "$CERT_P12"
          
          # Ø§Ø®ØªØ¨Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
          echo ""
          echo "--- Testing password with OpenSSL ---"
          if openssl pkcs12 -in "$CERT_P12" -noout -info -passin pass:"$IOS_P12_PASSWORD_CLEAN" 2>&1 | head -10; then
            echo "âœ… OpenSSL: Password verified successfully"
          else
            echo "âŒ OpenSSL: Password verification failed"
            exit 1
          fi
          
          # Ø­Ø°Ù keychain Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆÙØ¬Ø¯
          security delete-keychain build.keychain 2>/dev/null || true
          
          # Ø¥Ù†Ø´Ø§Ø¡ keychain
          echo ""
          echo "--- Creating keychain ---"
          security create-keychain -p "$KEYCHAIN_PASSWORD_CLEAN" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD_CLEAN" build.keychain
          security list-keychains -d user -s build.keychain
          echo "âœ… Keychain created and configured"
          
          # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙˆØ§Ù„Ù…ÙØªØ§Ø­
          echo ""
          echo "--- Extracting certificate and private key (PEM format) ---"
          
          CERT_PEM="$RUNNER_TEMP/cert.pem"
          KEY_PEM="$RUNNER_TEMP/key.pem"
          CA_CERTS="$RUNNER_TEMP/ca.pem"
          
          openssl pkcs12 -in "$CERT_P12" -clcerts -nokeys -out "$CERT_PEM" \
            -passin pass:"$IOS_P12_PASSWORD_CLEAN"
          
          openssl pkcs12 -in "$CERT_P12" -nocerts -nodes -out "$KEY_PEM" \
            -passin pass:"$IOS_P12_PASSWORD_CLEAN"
          
          openssl pkcs12 -in "$CERT_P12" -cacerts -nokeys -out "$CA_CERTS" \
            -passin pass:"$IOS_P12_PASSWORD_CLEAN" 2>/dev/null || true
          
          echo "âœ… Extracted certificate and key to PEM format"
          ls -lh "$CERT_PEM" "$KEY_PEM"
          
          # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
          echo ""
          echo "--- Importing certificate to keychain ---"
          if security import "$CERT_PEM" -k build.keychain -T /usr/bin/codesign -T /usr/bin/security; then
            echo "âœ… Certificate imported"
          else
            echo "âŒ Certificate import failed"
            exit 1
          fi
          
          # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ
          echo "--- Importing private key to keychain ---"
          if security import "$KEY_PEM" -k build.keychain -T /usr/bin/codesign -T /usr/bin/security -A; then
            echo "âœ… Private key imported"
          else
            echo "âŒ Private key import failed"
            exit 1
          fi
          
          # Ø§Ø³ØªÙŠØ±Ø§Ø¯ CA certificates
          if [ -s "$CA_CERTS" ]; then
            echo "--- Importing CA certificates ---"
            security import "$CA_CERTS" -k build.keychain -T /usr/bin/codesign -T /usr/bin/security 2>/dev/null || echo "âš ï¸  CA import skipped"
          fi
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØµÙˆÙ„
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD_CLEAN" build.keychain
          
          echo ""
          echo "--- Code signing identities ---"
          security find-identity -v -p codesigning build.keychain
          
          # Ù…Ø¹Ø§Ù„Ø¬Ø© provisioning profile
          echo ""
          echo "--- Installing provisioning profile for ${{ matrix.app }} ---"
          PROFILE_PLIST="$RUNNER_TEMP/profile.plist"
          security cms -D -i "$PROFILE" > "$PROFILE_PLIST"
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$PROFILE_PLIST")
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$PROFILE_PLIST")
          TEAM_ID=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' "$PROFILE_PLIST")
          PROFILE_BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:application-identifier' "$PROFILE_PLIST" | sed "s/^${TEAM_ID}\.//")
          
          echo "Profile Name: $PROFILE_NAME"
          echo "Profile UUID: $PROFILE_UUID"
          echo "Profile Bundle ID: $PROFILE_BUNDLE_ID"
          echo "Expected Bundle ID: $BUNDLE_ID"
          echo "Team ID: $TEAM_ID"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Bundle ID
          if [ "$PROFILE_BUNDLE_ID" != "$BUNDLE_ID" ] && [ "$PROFILE_BUNDLE_ID" != "*" ]; then
            WILDCARD_PREFIX=$(echo "$PROFILE_BUNDLE_ID" | sed 's/\.\*$//')
            if [[ "$BUNDLE_ID" != "$WILDCARD_PREFIX"* ]]; then
              echo "âš ï¸  Warning: Bundle ID mismatch!"
              echo "   Profile Bundle ID: $PROFILE_BUNDLE_ID"
              echo "   Expected Bundle ID: $BUNDLE_ID"
            fi
          fi
          
          # Ø§ÙƒØªØ´Ø§Ù Ù†ÙˆØ¹ provisioning profile
          echo ""
          echo "--- Detecting provisioning profile type ---"
          
          HAS_DEVICES="false"
          
          if /usr/libexec/PlistBuddy -c 'Print :ProvisionedDevices' "$PROFILE_PLIST" &>/dev/null; then
            HAS_DEVICES="true"
            DEVICE_COUNT=$(/usr/libexec/PlistBuddy -c 'Print :ProvisionedDevices' "$PROFILE_PLIST" 2>/dev/null | grep -c "    " || echo "0")
            echo "ProvisionedDevices: YES (count: ~$DEVICE_COUNT)"
          else
            echo "ProvisionedDevices: NO (App Store profile)"
          fi
          
          GET_TASK_ALLOW_VALUE=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:get-task-allow' "$PROFILE_PLIST" 2>/dev/null || echo "not_found")
          echo "get-task-allow: $GET_TASK_ALLOW_VALUE"
          
          if [ "$HAS_DEVICES" = "true" ]; then
            if [ "$GET_TASK_ALLOW_VALUE" = "true" ]; then
              EXPORT_METHOD="development"
              echo "âœ… Detected: Development provisioning profile"
            else
              EXPORT_METHOD="ad-hoc"
              echo "âœ… Detected: Ad-Hoc provisioning profile"
            fi
          else
            EXPORT_METHOD="app-store"
            echo "âœ… Detected: App Store provisioning profile"
          fi
          
          echo ""
          echo "PROFILE_NAME=$PROFILE_NAME" >> "$GITHUB_ENV"
          echo "PROFILE_UUID=$PROFILE_UUID" >> "$GITHUB_ENV"
          echo "TEAM_ID=$TEAM_ID" >> "$GITHUB_ENV"
          echo "EXPORT_METHOD=$EXPORT_METHOD" >> "$GITHUB_ENV"
          
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE" "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"
          
          echo ""
          echo "âœ… iOS code signing setup completed for ${{ matrix.app }}"
          echo "==========================================="

      - name: Build IPA
        if: ${{ github.event_name != 'pull_request' }}
        env:
          API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID }}
        working-directory: ./${{ matrix.app }}
        run: |
          set -euo pipefail
          
          echo "==========================================="
          echo "ðŸš€ Building IPA for ${{ matrix.app }}"
          echo "==========================================="
          echo "Bundle ID: $BUNDLE_ID"
          echo "Export Method: $EXPORT_METHOD"
          echo "Team ID: $TEAM_ID"
          echo "Profile Name: $PROFILE_NAME"
          echo ""
          
          # ØªØ­Ø¯ÙŠØ¯ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
          USE_API_KEY=false
          if [ -n "${API_KEY_PATH:-}" ] && [ -f "${API_KEY_PATH}" ]; then
            USE_API_KEY=true
            echo "âœ… App Store Connect API Key found - Using Automatic Signing"
          else
            echo "âš ï¸  App Store Connect API Key not found - Using Manual Signing"
          fi
          
          echo ""
          echo "--- Building Archive ---"
          
          if [ "$USE_API_KEY" = true ]; then
            xcodebuild -workspace ios/Runner.xcworkspace \
              -scheme Runner \
              -configuration Release \
              -sdk iphoneos \
              -destination 'generic/platform=iOS' \
              -archivePath build/Runner.xcarchive \
              -authenticationKeyPath "${API_KEY_PATH}" \
              -authenticationKeyID "$API_KEY_ID" \
              -authenticationKeyIssuerID "$API_ISSUER_ID" \
              CODE_SIGN_STYLE=Automatic \
              DEVELOPMENT_TEAM="$TEAM_ID" \
              -allowProvisioningUpdates \
              archive
          else
            xcodebuild -workspace ios/Runner.xcworkspace \
              -scheme Runner \
              -configuration Release \
              -sdk iphoneos \
              -destination 'generic/platform=iOS' \
              -archivePath build/Runner.xcarchive \
              DEVELOPMENT_TEAM="$TEAM_ID" \
              CODE_SIGN_STYLE=Manual \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
              archive
          fi
          
          echo ""
          echo "âœ… Archive created successfully"
          
          # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ù€ archive
          if [ -d "build/Runner.xcarchive/Products/Applications/Runner.app" ]; then
            echo ""
            echo "--- App Info ---"
            codesign -dv "build/Runner.xcarchive/Products/Applications/Runner.app" 2>&1 | grep -E "Authority|TeamIdentifier|Identifier" || true
          fi
          
          echo ""
          echo "--- Exporting IPA ---"
          
          EXPORT_OPTIONS_PLIST="$RUNNER_TEMP/ExportOptions.plist"
          
          # ØªØ­Ø¯ÙŠØ¯ export method
          FINAL_EXPORT_METHOD="$EXPORT_METHOD"
          if [ "$EXPORT_METHOD" = "ad-hoc" ]; then
            FINAL_EXPORT_METHOD="development"
          fi
          
          echo "Export Method: $FINAL_EXPORT_METHOD"
          
          rm -f "$EXPORT_OPTIONS_PLIST"
          rm -f "$RUNNER_TEMP/ExportOptions.plist"
          
          # ØªØ­Ø¯ÙŠØ¯ signing style
          if [ "$USE_API_KEY" = true ]; then
            SIGNING_STYLE="automatic"
          else
            SIGNING_STYLE="manual"
          fi
          
          echo "Signing Style: $SIGNING_STYLE"
          
          # Ø¥Ù†Ø´Ø§Ø¡ plist
          defaults write "$RUNNER_TEMP/ExportOptions" teamID "$TEAM_ID"
          defaults write "$RUNNER_TEMP/ExportOptions" method "$FINAL_EXPORT_METHOD"
          defaults write "$RUNNER_TEMP/ExportOptions" signingStyle "$SIGNING_STYLE"
          defaults write "$RUNNER_TEMP/ExportOptions" compileBitcode -bool false
          defaults write "$RUNNER_TEMP/ExportOptions" uploadSymbols -bool false
          defaults write "$RUNNER_TEMP/ExportOptions" stripSwiftSymbols -bool true
          
          if [ "$SIGNING_STYLE" = "manual" ]; then
            defaults write "$RUNNER_TEMP/ExportOptions" provisioningProfiles -dict "$BUNDLE_ID" "$PROFILE_UUID"
          fi
          
          echo ""
          echo "--- ExportOptions.plist ---"
          plutil -p "$EXPORT_OPTIONS_PLIST"
          echo ""
          
          # Export IPA
          if [ "$USE_API_KEY" = true ]; then
            xcodebuild -exportArchive \
              -archivePath build/Runner.xcarchive \
              -exportOptionsPlist "$EXPORT_OPTIONS_PLIST" \
              -exportPath build/ipa \
              -authenticationKeyPath "${API_KEY_PATH}" \
              -authenticationKeyID "$API_KEY_ID" \
              -authenticationKeyIssuerID "$API_ISSUER_ID" \
              -allowProvisioningUpdates
          else
            xcodebuild -exportArchive \
              -archivePath build/Runner.xcarchive \
              -exportOptionsPlist "$EXPORT_OPTIONS_PLIST" \
              -exportPath build/ipa \
              -allowProvisioningUpdates
          fi
          
          echo ""
          echo "==========================================="
          echo "âœ… IPA Export Successful for ${{ matrix.app }}!"
          echo "==========================================="
          
          ls -lh build/ipa/*.ipa || ls -la build/ipa

      - name: Rename IPA with app name and version
        if: ${{ github.event_name != 'pull_request' }}
        working-directory: ./${{ matrix.app }}
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
          BUILD_NUMBER=${{ github.run_number }}
          APP_NAME="${{ matrix.app }}"
          IPA_NAME="${APP_NAME}-v${VERSION}+${BUILD_NUMBER}-iOS.ipa"
          
          if ls build/ipa/*.ipa 1> /dev/null 2>&1; then
            mv build/ipa/*.ipa "build/ipa/${IPA_NAME}"
            echo "âœ… Renamed IPA to: ${IPA_NAME}"
            echo "IPA_NAME=${IPA_NAME}" >> $GITHUB_ENV
            echo "VERSION=${VERSION}" >> $GITHUB_ENV
            echo "BUILD_NUMBER=${BUILD_NUMBER}" >> $GITHUB_ENV
          else
            echo "âŒ No IPA file found"
            exit 1
          fi

      - name: Upload IPA artifact
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-ios-ipa
          path: ./${{ matrix.app }}/build/ipa/*.ipa
          retention-days: 30

      - name: Upload dSYM artifact
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-ios-dsym
          path: ./${{ matrix.app }}/build/Runner.xcarchive/dSYMs
          retention-days: 30
          if-no-files-found: ignore

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Build Android
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-android:
    name: Build ${{ matrix.app }} for Android
    needs: setup
    if: |
      needs.setup.outputs.has_apps == 'true' && 
      github.event.inputs.platform != 'ios'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set App Configuration
        run: |
          echo "==========================================="
          echo "âš™ï¸  Setting configuration for ${{ matrix.app }}"
          echo "==========================================="
          
          case "${{ matrix.app }}" in
            "hggzk_app")
              echo "ANDROID_BUNDLE_ID=com.hggzk.app" >> "$GITHUB_ENV"
              echo "APP_DISPLAY_NAME=HGGZK" >> "$GITHUB_ENV"
              ;;
            "hggzkportal_app")
              echo "ANDROID_BUNDLE_ID=com.hggzkportal.app" >> "$GITHUB_ENV"
              echo "APP_DISPLAY_NAME=HGGZK Portal" >> "$GITHUB_ENV"
              ;;
            "rezmate_app")
              echo "ANDROID_BUNDLE_ID=com.rezmate.app" >> "$GITHUB_ENV"
              echo "APP_DISPLAY_NAME=Rezmate" >> "$GITHUB_ENV"
              ;;
            "rezmateportal_app")
              echo "ANDROID_BUNDLE_ID=com.rezmate.portal" >> "$GITHUB_ENV"
              echo "APP_DISPLAY_NAME=Rezmate Portal" >> "$GITHUB_ENV"
              ;;
          esac
          
          echo "âœ… Configuration set successfully"
          echo "==========================================="

      - name: SSH debug (tmate)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.ssh }}
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

      - name: Flutter version
        run: flutter --version

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ matrix.app }}-${{ hashFiles(format('{0}/android/gradle/wrapper/gradle-wrapper.properties', matrix.app)) }}
          restore-keys: |
            ${{ runner.os }}-gradle-${{ matrix.app }}-

      - name: Flutter clean
        working-directory: ./${{ matrix.app }}
        run: flutter clean

      - name: Flutter pub get
        working-directory: ./${{ matrix.app }}
        run: flutter pub get

      - name: Build APK (Debug) for PR
        if: ${{ github.event_name == 'pull_request' }}
        working-directory: ./${{ matrix.app }}
        run: flutter build apk --debug

      - name: Setup Android Keystore
        if: ${{ github.event_name != 'pull_request' }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          
          echo "--- Setting up Android Keystore for ${{ matrix.app }} ---"
          
          if [ -n "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            KEYSTORE_PATH="$RUNNER_TEMP/upload-keystore.jks"
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > "$KEYSTORE_PATH"
            
            if [ -f "$KEYSTORE_PATH" ]; then
              echo "âœ… Keystore file created: $(ls -lh $KEYSTORE_PATH)"
            else
              echo "âŒ Failed to create keystore file"
              exit 1
            fi
            
            KEY_PROPERTIES="./${{ matrix.app }}/android/key.properties"
            cat > "$KEY_PROPERTIES" << EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=$KEYSTORE_PATH
          EOF
            
            echo "âœ… Android Keystore configured for ${{ matrix.app }}"
            echo "KEYSTORE_PATH=$KEYSTORE_PATH" >> "$GITHUB_ENV"
            echo "SIGNING_CONFIGURED=true" >> "$GITHUB_ENV"
          else
            echo "âš ï¸  Android Keystore not provided - will build unsigned APK"
            echo "SIGNING_CONFIGURED=false" >> "$GITHUB_ENV"
          fi

      - name: Build APK (Release)
        if: ${{ github.event_name != 'pull_request' }}
        working-directory: ./${{ matrix.app }}
        run: |
          echo "--- Building Release APK for ${{ matrix.app }} ---"
          flutter build apk --release
          
          echo ""
          echo "âœ… APK built successfully"
          ls -lh build/app/outputs/flutter-apk/*.apk

      - name: Build App Bundle (AAB)
        if: ${{ github.event_name != 'pull_request' }}
        working-directory: ./${{ matrix.app }}
        run: |
          echo "--- Building App Bundle for ${{ matrix.app }} ---"
          flutter build appbundle --release
          
          echo ""
          echo "âœ… AAB built successfully"
          ls -lh build/app/outputs/bundle/release/*.aab

      - name: Rename artifacts with app name and version
        if: ${{ github.event_name != 'pull_request' }}
        working-directory: ./${{ matrix.app }}
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
          BUILD_NUMBER=${{ github.run_number }}
          APP_NAME="${{ matrix.app }}"
          
          APK_NAME="${APP_NAME}-v${VERSION}+${BUILD_NUMBER}-Android.apk"
          AAB_NAME="${APP_NAME}-v${VERSION}+${BUILD_NUMBER}-Android.aab"
          
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            mv "build/app/outputs/flutter-apk/app-release.apk" "build/app/outputs/flutter-apk/${APK_NAME}"
            echo "âœ… Renamed APK to: ${APK_NAME}"
          fi
          
          if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            mv "build/app/outputs/bundle/release/app-release.aab" "build/app/outputs/bundle/release/${AAB_NAME}"
            echo "âœ… Renamed AAB to: ${AAB_NAME}"
          fi
          
          echo "APK_NAME=${APK_NAME}" >> $GITHUB_ENV
          echo "AAB_NAME=${AAB_NAME}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "BUILD_NUMBER=${BUILD_NUMBER}" >> $GITHUB_ENV

      - name: Upload APK artifact
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-android-apk
          path: ./${{ matrix.app }}/build/app/outputs/flutter-apk/*.apk
          retention-days: 30

      - name: Upload AAB artifact
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-android-aab
          path: ./${{ matrix.app }}/build/app/outputs/bundle/release/*.aab
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Build Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify-completion:
    name: Build Summary
    needs: [setup, build-ios, build-android]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check Build Status
        run: |
          echo "==========================================="
          echo "ðŸ“Š Build Status Summary"
          echo "==========================================="
          
          IOS_STATUS="${{ needs.build-ios.result }}"
          ANDROID_STATUS="${{ needs.build-android.result }}"
          
          echo ""
          echo "ðŸŽ iOS Build: $IOS_STATUS"
          echo "ðŸ¤– Android Build: $ANDROID_STATUS"
          echo ""
          
          if [ "$IOS_STATUS" == "success" ]; then
            echo "âœ… iOS builds completed successfully!"
          elif [ "$IOS_STATUS" == "skipped" ]; then
            echo "â­ï¸  iOS builds were skipped"
          else
            echo "âŒ iOS builds failed!"
          fi
          
          if [ "$ANDROID_STATUS" == "success" ]; then
            echo "âœ… Android builds completed successfully!"
          elif [ "$ANDROID_STATUS" == "skipped" ]; then
            echo "â­ï¸  Android builds were skipped"
          else
            echo "âŒ Android builds failed!"
          fi
          
          echo ""
          echo "==========================================="

      - name: Generate Summary
        run: |
          echo "## ðŸ“± Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ iOS | ${{ needs.build-ios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¤– Android | ${{ needs.build-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Built Apps" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.setup.outputs.matrix }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Download the built apps from the **Artifacts** section above." >> $GITHUB_STEP_SUMMARY