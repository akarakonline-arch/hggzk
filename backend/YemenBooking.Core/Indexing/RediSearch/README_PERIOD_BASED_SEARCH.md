# ูุธุงู ุงูููุฑุณุฉ ูุงูุจุญุซ ุงููุญุณูู - Period-Based Search

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุนุงุฏุฉ ุจูุงุก ูุธุงู ุงูููุฑุณุฉ ุจุงููุงูู ููุนุชูุฏ ุนูู **RediSearch** ูุน ุงุณุชุฑุงุชูุฌูุฉ **Period-Based Indexing** ุงูุชู ุชุณูุญ ุจุงูุจุญุซ ูุงูููุชุฑุฉ **ูุจุงุดุฑุฉ ุนูู ูุณุชูู Redis** ููุชูุงุฑูุฎ ูุงูุฃุณุนุงุฑ.

---

## โจ ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ

### 1. ููุฑุณุฉ ุซูุงุซุฉ ุฃููุงุน ูู ุงููุณุชูุฏุงุช

```
๐ฆ unit:{unitId}              โ ุจูุงูุงุช ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ
๐ period:price:{ruleId}      โ ูุชุฑุฉ ุชุณุนูุฑ ูุงุญุฏุฉ
๐ period:avail:{availId}     โ ูุชุฑุฉ ุฅุชุงุญุฉ ูุงุญุฏุฉ
```

### 2. ุงูุจุญุซ ุงููุจุงุดุฑ ูู ุงูุชูุงุฑูุฎ ุนูู Redis

- โ **ุชู ุญุฐู**: `IS_AVAILABLE`, `MIN_DAILY_PRICE`, `MAX_DAILY_PRICE`
- โ **ุงูุจุฏูู**: ุงูุจุญุซ ุงููุจุงุดุฑ ูู ุงููุชุฑุงุช ุจุงุณุชุฎุฏุงู RediSearch

### 3. ุงูุงูุชุฒุงู ุจุงูููุงุนุฏ ุงููุญุฏุฏุฉ

- โ ุงูุณุนุฑ ูู `PricingRule` ุญุณุจ ุงูุชุงุฑูุฎุ ูุฅูุง `BasePrice`
- โ ุงูุฅุชุงุญุฉ ูู `UnitAvailability`ุ ููู ูุงููุด ุณุฌู = ูุชุงุญุฉ
- โ ูุญุต ุงูุชูุงุทุน ุจูู ุงููุชุฑุงุช ูุจุงุดุฑุฉ ูู Redis

---

## ๐ ุงูุจููุฉ ุงููุนูุงุฑูุฉ

### ุงูุทุจูุงุช ุงูุฃุณุงุณูุฉ

```
YemenBooking.Core/Indexing/RediSearch/
โโโ PeriodBasedSearchSchema.cs      โ ุชุนุฑูู ุงูููุงุฑุณ ุงูุซูุงุซุฉ
โโโ PeriodBasedQueryBuilder.cs      โ ุจูุงุก ุงุณุชุนูุงูุงุช RediSearch
โโโ PeriodBasedHashBuilder.cs       โ ุจูุงุก ุงูุจูุงูุงุช ููููุฑุณุฉ
โโโ DateRangeHelper.cs              โ ุญุณุงุจ ุงูุณุนุฑ ูุงูุฅุชุงุญุฉ
```

---

## ๐ ุงุณุชุฑุงุชูุฌูุฉ ุงูุจุญุซ

### ุงูุชุฑุชูุจ ุงููุญุฏุฏ (ุญุณุจ ุทูุจู):

```
1๏ธโฃ ุงููุฏููุฉ (City)
2๏ธโฃ ููุน ุงูุนูุงุฑ (PropertyTypeId)
3๏ธโฃ ููุน ุงููุญุฏุฉ (UnitTypeId)
4๏ธโฃ + 5๏ธโฃ ุชุงุฑูุฎ ุงููุตูู ูุงููุบุงุฏุฑุฉ (CheckIn / CheckOut)
6๏ธโฃ ุงูุญููู ุงูุฏููุงููููุฉ (DynamicFieldFilters)
7๏ธโฃ ุงููุฑุงูู (RequiredAmenities)
8๏ธโฃ ุงูุฎุฏูุงุช (RequiredServices)
```

### ุฎุทูุงุช ุงูุชูููุฐ:

#### **ุงููุฑุญูุฉ 1: ููุชุฑุฉ ุงูุฅุชุงุญุฉ (ุฅุฐุง ูุงูุช ููุงู ุชูุงุฑูุฎ)**

```csharp
// ุงูุจุญุซ ูู idx:periods:avail ุนู ุงููุชุฑุงุช ุงููุญุฌูุฒุฉ
FT.SEARCH idx:periods:avail 
  "@status:{Blocked|Booked} 
   @startDateTs:[-inf 1735689600] 
   @endDateTs:[1733011200 +inf]"
   
// ุงููุชูุฌุฉ: ูุงุฆูุฉ UnitIds ุงููุญุฌูุฒุฉ
// ูุณุชุซูููุง ูู ุงูุจุญุซ ุงูุฑุฆูุณู
```

#### **ุงููุฑุญูุฉ 2: ุงูุจุญุซ ูู ุงููุญุฏุงุช**

```csharp
// ุงูุจุญุซ ูู idx:units:v3
FT.SEARCH idx:units:v3 
  "@city:{ุตูุนุงุก} 
   @propertyTypeId:{guid1} 
   @unitTypeId:{guid2}
   @amenityIds:{guid3,guid4}
   -@unitId:(excludedIds)"
```

#### **ุงููุฑุญูุฉ 3: ุญุณุงุจ ุงูุณุนุฑ ูููุชุฑุฉ**

```csharp
// ููู ูุญุฏุฉ ูู ุงููุชุงุฆุฌ:
FT.SEARCH idx:periods:price 
  "@unitId:{unitGuid} 
   @startDateTs:[-inf checkOutTs] 
   @endDateTs:[checkInTs +inf]"

// ุญุณุงุจ ุงูุณุนุฑ ุงูุฅุฌูุงูู ูู ุงููุชุฑุงุช ุงููุณุชุฑุฌุนุฉ
```

---

## ๐พ ุจููุฉ ุงูุจูุงูุงุช ูู Redis

### 1. ูุณุชูุฏ ุงููุญุฏุฉ

```redis
HSET unit:abc123-... 
  unitId "abc123..."
  propertyId "def456..."
  unitName "ุฌูุงุญ ูููู"
  city "ุตูุนุงุก"
  propertyTypeId "guid1"
  unitTypeId "guid2"
  basePrice "1000"
  currency "YER"
  amenityIds "amenity1,amenity2,amenity3"
  maxCapacity "4"
  adultsCapacity "2"
  location "44.1234,15.5678"
  df_bedrooms "2"
  dfn_area "120"
  ...
```

### 2. ูุณุชูุฏ ูุชุฑุฉ ุงูุชุณุนูุฑ

```redis
HSET period:price:rule123
  pricingRuleId "rule123"
  unitId "abc123..."
  propertyId "def456..."
  startDateTs "1733011200"    # 2024-12-01 00:00:00
  endDateTs "1735689600"      # 2025-01-01 00:00:00
  price "1500"
  currency "YER"
```

### 3. ูุณุชูุฏ ูุชุฑุฉ ุงูุฅุชุงุญุฉ (ุงููุญุฌูุฒุฉ ููุท)

```redis
HSET period:avail:avail456
  availabilityId "avail456"
  unitId "abc123..."
  propertyId "def456..."
  startDateTs "1734220800"    # 2024-12-15 00:00:00
  endDateTs "1734566400"      # 2024-12-20 00:00:00
  status "Booked"
  bookingId "booking789"
```

---

## ๐ง ุงูููุงุนุฏ ูุงูููุทู

### ูุงุนุฏุฉ ุงูุณุนุฑ:

```
ุฅุฐุง ูุงู (ุงูุชุงุฑูุฎ ุถูู ูุทุงู PricingRule):
  โ ุงุณุชุฎุฏู PriceAmount ูู ุงููุงุนุฏุฉ
ูุฅูุง:
  โ ุงุณุชุฎุฏู BasePrice ูู ุงููุญุฏุฉ
```

### ูุงุนุฏุฉ ุงูุฅุชุงุญุฉ:

```
ุฅุฐุง ูู ููู ููุงู ุณุฌู ูู UnitAvailability:
  โ ุงููุญุฏุฉ ูุชุงุญุฉ (ุงูุงูุชุฑุงุถ)

ุฅุฐุง ูุงู ููุงู ุณุฌู:
  โ ูุญุต ุงูุชูุงุทุน ูุน ุงููุชุฑุฉ ุงููุทููุจุฉ:
     - ุฅุฐุง Status = "Available" โ ูุชุงุญุฉ โ
     - ุฅุฐุง Status = "Blocked" ุฃู "Booked" โ ุบูุฑ ูุชุงุญุฉ โ
```

### ูุญุต ุงูุชูุงุทุน ุจูู ูุชุฑุชูู:

```
Period1: [start1, end1]
Period2: [start2, end2]

ุชูุงุทุน = (start1 < end2) AND (start2 < end1)
```

---

## ๐ ุฃูุซูุฉ ุนูู ุงูุงุณุชุนูุงูุงุช

### ูุซุงู 1: ุจุญุซ ุจุณูุท (ุจุฏูู ุชูุงุฑูุฎ)

```
ุงูุทูุจ:
- ุงููุฏููุฉ: ุตูุนุงุก
- ููุน ุงูุนูุงุฑ: ููุฏู
- ุงููุฑุงูู: wifi, ูุณุจุญ

ุงูุงุณุชุนูุงู:
FT.SEARCH idx:units:v3 
  "@city:{ุตูุนุงุก} 
   @propertyTypeId:{hotel-guid} 
   @amenityIds:{wifi-guid} 
   @amenityIds:{pool-guid}"
   LIMIT 0 20
```

### ูุซุงู 2: ุจุญุซ ูุน ุชูุงุฑูุฎ

```
ุงูุทูุจ:
- ุงููุฏููุฉ: ุตูุนุงุก
- ุชุงุฑูุฎ ุงููุตูู: 2024-12-20
- ุชุงุฑูุฎ ุงููุบุงุฏุฑุฉ: 2024-12-25
- ุนุฏุฏ ุงูุถููู: 2

ุงูุฎุทูุงุช:
1. FT.SEARCH idx:periods:avail ููุญุตูู ุนูู ุงููุญุฏุงุช ุงููุญุฌูุฒุฉ
2. FT.SEARCH idx:units:v3 ูุน ุงุณุชุซูุงุก ุงููุญุฏุงุช ุงููุญุฌูุฒุฉ
3. ููู ูุชูุฌุฉ: FT.SEARCH idx:periods:price ูุญุณุงุจ ุงูุณุนุฑ
4. ููุชุฑุฉ ุญุณุจ MinPrice/MaxPrice (ุฅู ูุฌุฏ)
```

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ ููุชูููุฐ

### ูุง ุชู ุฅูุฌุงุฒู โ

1. โ `PeriodBasedSearchSchema` - ุชุนุฑูู ุงูููุงุฑุณ ุงูุซูุงุซุฉ
2. โ `PeriodBasedQueryBuilder` - ุจูุงุก ุงูุงุณุชุนูุงูุงุช
3. โ `PeriodBasedHashBuilder` - ุจูุงุก ุงูุจูุงูุงุช
4. โ `DateRangeHelper` - ุญุณุงุจ ุงูุณุนุฑ ูุงูุฅุชุงุญุฉ

### ูุง ูุญุชุงุฌ ููุฅููุงู โณ

1. โณ **ุฎุฏูุฉ ุงูููุฑุณุฉ** (`OptimizedUnitIndexingService`)
   - ููุฑุณุฉ ุงููุญุฏุฉ + ูุชุฑุงุช ุงูุชุณุนูุฑ + ูุชุฑุงุช ุงูุฅุชุงุญุฉ
   - ูุนุงูุฌุฉ ุฃุญุฏุงุซ ุงูุชุญุฏูุซ ูุงูุญุฐู

2. โณ **ุฎุฏูุฉ ุงูุจุญุซ** (`OptimizedUnitSearchEngine`)
   - ุชูููุฐ ุงูุงุณุชุฑุงุชูุฌูุฉ ูุชุนุฏุฏุฉ ุงููุฑุงุญู
   - ุญุณุงุจ ุงูุณุนุฑ ุงูุฅุฌูุงูู ูู ุงููุชุฑุงุช
   - ููุชุฑุฉ ููุงุฆูุฉ ุญุณุจ ุงูุณุนุฑ

3. โณ **ุชุญุฏูุซ ุงููุงุฌูุงุช** (ูู Application Layer)
   - `IIndexingService` - ูุฏ ุชุญุชุงุฌ ูุชุนุฏููุงุช ุทูููุฉ
   - `IUnitIndexingService` - ุงูุชูุงูู ูุน ุงููููู ุงูุฌุฏูุฏ

4. โณ **Migration Script**
   - ููู ุงูุจูุงูุงุช ูู ุงูููุฑุณ ุงููุฏูู ููุฌุฏูุฏ
   - ุฅูุดุงุก ุงูููุงุฑุณ ุงูุซูุงุซุฉ ูู Redis
   - ุฅุนุงุฏุฉ ููุฑุณุฉ ุฌููุน ุงููุญุฏุงุช

---

## ๐ ููุงุญุธุงุช ูููุฉ

### ุงูุฃุฏุงุก

- โ ุงูุจุญุซ ูู ุงููุชุฑุงุช ูุชู **ูุจุงุดุฑุฉ ุนูู Redis** ุจุฏูู ุฌูุจ JSON
- โ ููุฑุณุฉ ุงููุชุฑุงุช ุงููุญุฌูุฒุฉ ููุท (ุชูููุฑ ูุณุงุญุฉ)
- โ ุงุณุชุฎุฏุงู NUMERIC indexes ููุชูุงุฑูุฎ (ุจุญุซ ุณุฑูุน ุฌุฏุงู)
- โ๏ธ Post-processing ูุญุฏูุฏ ููุท ูุญุณุงุจ ุงูุณุนุฑ ุงูููุงุฆู

### ุงูุชูุงูููุฉ

- โ ูุชูุงูู ูุน ุฌููุน ุฃููุงุน `PricingMethod` (Hourly, Daily, Weekly, Monthly)
- โ ูุฏุนู ุนููุงุช ูุชุนุฏุฏุฉ
- โ ูุฏุนู ุงูุญููู ุงูุฏููุงููููุฉ ุจุฃููุงุนูุง (ูุตูุฉ ูุฑูููุฉ)

### ุงูุตูุงูุฉ

- ๐ ุนูุฏ ุชุญุฏูุซ `PricingRule` โ ุชุญุฏูุซ `period:price:{ruleId}`
- ๐ ุนูุฏ ุชุญุฏูุซ `UnitAvailability` โ ุชุญุฏูุซ `period:avail:{availId}`
- ๐ ุนูุฏ ุญุฐู ูุงุนุฏุฉ โ ุญุฐู ุงููุณุชูุฏ ูู Redis
- ๐งน ุชูุธูู ุฏูุฑู ูููุชุฑุงุช ุงููุฏููุฉ (ุฃูุฏู ูู 6 ุฃุดูุฑ ูุซูุงู)

---

## ๐ฏ ุงูุฎูุงุตุฉ

ุชู ุชุตููู ุงููุธุงู ุงูุฌุฏูุฏ ููููู:

1. **ุฏููู 100%**: ูุทุจู ุฌููุน ุงูููุงุนุฏ ุงููุญุฏุฏุฉ
2. **ุณุฑูุน**: ุงูุจุญุซ ูุงูููุชุฑุฉ ุนูู Redis ูุจุงุดุฑุฉ
3. **ูุงุจู ููุชูุณุน**: ุณูู ุฅุถุงูุฉ ูุนุงููุฑ ุจุญุซ ุฌุฏูุฏุฉ
4. **ููุซูู**: ูุง ูุนุชูุฏ ุนูู ุงูุชุฑุงุถุงุช ุฃู ุญุณุงุจุงุช ุชูุฑูุจูุฉ

---

## ๐ ูููุชุงุจุนุฉ

ุงููููุงุช ุงูุฌุงูุฒุฉ:
- โ `PeriodBasedSearchSchema.cs`
- โ `PeriodBasedQueryBuilder.cs`
- โ `PeriodBasedHashBuilder.cs`
- โ `DateRangeHelper.cs`

ุงูุชุงูู: ุฅูุดุงุก ุฎุฏูุงุช ุงูููุฑุณุฉ ูุงูุจุญุซ ุงููุนููุฉ.
